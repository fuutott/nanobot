<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>{{TITLE}}</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#0f1117;--sidebar:#161b22;--border:#30363d;--accent:#2ea043;
    --accent-hover:#3fb950;--msg-user:#1c2128;--msg-bot:#0d1117;
    --text:#e6edf3;--text-muted:#8b949e;--input-bg:#1c2128;
    --scrollbar:#30363d;--danger:#da3633;--hover:#21262d;
    --radius:12px;--font:'Segoe UI',system-ui,sans-serif;--mobile-sidebar-width:min(78vw,280px);--mobile-backdrop:rgba(0,0,0,.45);
  }
  html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:var(--font)}
  #app{display:flex;height:100vh}

  /* ── Sidebar ── */
  #sidebar{
    width:260px;min-width:200px;max-width:320px;
    background:var(--sidebar);border-right:1px solid var(--border);
    display:flex;flex-direction:column;
  }
  #sidebar-header{padding:16px 12px 8px;display:flex;align-items:center;gap:8px}
  #sidebar-title{font-size:15px;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  #btn-new{
    background:var(--accent);border:none;color:#fff;border-radius:8px;
    padding:6px 12px;font-size:13px;cursor:pointer;white-space:nowrap;transition:.15s
  }
  #btn-new:hover{background:var(--accent-hover)}
  #chat-list{flex:1;overflow-y:auto;padding:4px 8px 8px}
  .chat-item{
    display:flex;align-items:center;gap:6px;border-radius:8px;
    padding:8px 10px;cursor:pointer;transition:.1s;position:relative;
  }
  .chat-item:hover,.chat-item.active{background:var(--hover)}
  .chat-item.active{background:var(--hover)}
  .chat-item-title{flex:1;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .chat-item-del{
    opacity:0;background:none;border:none;color:var(--text-muted);cursor:pointer;
    font-size:15px;padding:2px 4px;border-radius:4px;transition:.1s;flex-shrink:0
  }
  .chat-item:hover .chat-item-del{opacity:1}
  .chat-item-del:hover{color:var(--danger);background:rgba(218,54,51,.15)}

  /* ── Main ── */
  #main{flex:1;display:flex;flex-direction:column;overflow:hidden}
  #main-header{
    padding:12px 20px;border-bottom:1px solid var(--border);
    display:flex;align-items:center;gap:10px;min-height:52px
  }
  #btn-menu{
    display:none;background:none;border:1px solid var(--border);color:var(--text);
    width:34px;height:34px;border-radius:8px;cursor:pointer;align-items:center;justify-content:center
  }
  #btn-menu svg{width:18px;height:18px;fill:currentColor}
  #chat-title-display{font-size:15px;font-weight:600;flex:1;opacity:.9}
  #empty-state{
    flex:1;display:flex;flex-direction:column;align-items:center;
    justify-content:center;gap:16px;color:var(--text-muted)
  }
  #empty-state h2{font-size:22px;font-weight:600}
  #empty-state p{font-size:14px}
  #btn-new-big{
    background:var(--accent);border:none;color:#fff;border-radius:10px;
    padding:10px 24px;font-size:14px;cursor:pointer;transition:.15s
  }
  #btn-new-big:hover{background:var(--accent-hover)}

  /* ── Messages ── */
  #messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px}
  .msg{display:flex;flex-direction:column;gap:4px;max-width:820px;width:100%}
  .msg.user{align-self:flex-end;align-items:flex-end}
  .msg.assistant{align-self:flex-start;align-items:flex-start}
  .bubble{
    border-radius:var(--radius);padding:12px 16px;font-size:14px;
    line-height:1.6;word-break:break-word;
  }
  .msg.user .bubble{background:var(--accent);color:#fff;border-bottom-right-radius:4px}
  .msg.assistant .bubble{
    background:var(--msg-user);border:1px solid var(--border);
    border-bottom-left-radius:4px;
  }
  .msg-time{font-size:11px;color:var(--text-muted);padding:0 4px}

  /* Markdown inside bubbles */
  .bubble p{margin-bottom:.6em}.bubble p:last-child{margin-bottom:0}
  .bubble pre{background:#0d1117;border:1px solid var(--border);border-radius:8px;
    padding:12px;overflow-x:auto;margin:.6em 0}
  .bubble code{font-family:'Cascadia Code','JetBrains Mono',monospace;font-size:.88em}
  .bubble pre code{color:#e6edf3}
  .bubble :not(pre)>code{background:#21262d;padding:2px 5px;border-radius:4px}
  .bubble h1,.bubble h2,.bubble h3{margin:.4em 0 .2em}
  .bubble ul,.bubble ol{padding-left:1.2em;margin:.4em 0}
  .bubble a{color:#79c0ff}
  .bubble table{border-collapse:collapse;margin:.6em 0;width:100%}
  .bubble th,.bubble td{border:1px solid var(--border);padding:6px 10px;text-align:left}
  .bubble th{background:#21262d}

  /* Bubble images */
  .bubble-img{max-width:280px;max-height:220px;border-radius:8px;display:block;margin-bottom:4px;cursor:pointer}
  .bubble-file{display:inline-flex;align-items:center;gap:6px;background:var(--hover);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:13px;margin-bottom:4px}
  .bubble-file svg{width:14px;height:14px;fill:var(--text-muted);flex-shrink:0}
  .typing-bubble{display:flex;gap:5px;align-items:center;padding:14px 18px}
  .dot{width:7px;height:7px;border-radius:50%;background:var(--text-muted);animation:bounce 1.2s infinite}
  .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
  @keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}

  /* ── Input area ── */
  #input-area{border-top:1px solid var(--border);padding:14px 20px;background:var(--bg)}
  #attach-preview{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
  .attach-chip{
    display:flex;align-items:center;gap:4px;background:var(--hover);
    border:1px solid var(--border);border-radius:6px;padding:4px 8px;
    font-size:12px;color:var(--text);max-width:180px;
  }
  .attach-chip img{width:36px;height:36px;object-fit:cover;border-radius:4px;flex-shrink:0}
  .attach-chip-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
  .attach-chip-del{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:0 2px;font-size:14px;flex-shrink:0}
  .attach-chip-del:hover{color:var(--danger)}
  #input-wrap{
    display:flex;align-items:flex-end;gap:10px;
    background:var(--input-bg);border:1px solid var(--border);
    border-radius:12px;padding:10px 12px;transition:.15s
  }
  #input-wrap:focus-within{border-color:var(--accent)}
  #msg-input{
    flex:1;background:none;border:none;color:var(--text);
    font-size:14px;font-family:var(--font);line-height:1.5;
    resize:none;outline:none;max-height:200px;overflow-y:auto
  }
  #msg-input::placeholder{color:var(--text-muted)}
  #btn-attach{
    background:none;border:none;color:var(--text-muted);cursor:pointer;
    width:30px;height:30px;flex-shrink:0;display:flex;align-items:center;
    justify-content:center;border-radius:6px;transition:.15s
  }
  #btn-attach:hover{color:var(--text);background:var(--hover)}
  #btn-attach svg{width:18px;height:18px;fill:currentColor}
  #btn-send{
    background:var(--accent);border:none;color:#fff;border-radius:8px;
    width:34px;height:34px;cursor:pointer;flex-shrink:0;
    display:flex;align-items:center;justify-content:center;
    transition:.15s;opacity:.9
  }
  #btn-send:hover:not(:disabled){opacity:1;background:var(--accent-hover)}
  #btn-send:disabled{opacity:.35;cursor:default}
  #btn-send svg{width:16px;height:16px;fill:currentColor}

  /* Scrollbars */
  ::-webkit-scrollbar{width:6px;height:6px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:var(--scrollbar);border-radius:3px}
  ::-webkit-scrollbar-thumb:hover{background:#484f58}

  #sidebar-backdrop{display:none}
  @media(max-width:768px){
    #btn-menu{display:flex}
    #sidebar{
      position:fixed;left:0;top:0;bottom:0;z-index:30;max-width:none;width:var(--mobile-sidebar-width);
      transform:translateX(-100%);transition:transform .2s ease;
    }
    #app.sidebar-open #sidebar{transform:translateX(0)}
    #sidebar-backdrop{
      display:block;position:fixed;inset:0;background:var(--mobile-backdrop);z-index:20;
      opacity:0;pointer-events:none;transition:opacity .2s ease
    }
    #app.sidebar-open #sidebar-backdrop{opacity:1;pointer-events:auto}
    #main-header{padding:10px 12px}
    #messages{padding:12px}
    #input-area{padding:10px 12px}
    .msg{max-width:100%}
    .chat-item-del{opacity:1}
  }

  /* ── Login overlay ── */
  #login-overlay{
    position:fixed;inset:0;background:var(--bg);z-index:100;
    display:flex;align-items:center;justify-content:center;
  }
  #login-box{
    background:var(--sidebar);border:1px solid var(--border);border-radius:16px;
    padding:36px 40px;width:320px;display:flex;flex-direction:column;gap:16px;
  }
  #login-box h2{font-size:18px;font-weight:600;text-align:center}
  .login-field{display:flex;flex-direction:column;gap:6px}
  .login-field label{font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em}
  .login-field input{
    background:var(--input-bg);border:1px solid var(--border);color:var(--text);
    border-radius:8px;padding:9px 12px;font-size:14px;outline:none;font-family:var(--font);
    transition:.15s;
  }
  .login-field input:focus{border-color:var(--accent)}
  #login-error{font-size:13px;color:var(--danger);text-align:center;min-height:18px}
  #btn-login{
    background:var(--accent);border:none;color:#fff;border-radius:8px;
    padding:10px;font-size:14px;cursor:pointer;transition:.15s;font-family:var(--font);
  }
  #btn-login:hover{background:var(--accent-hover)}
</style>
</head>
<body>
<!-- Login overlay (hidden when no auth configured or after successful login) -->
<div id="login-overlay" style="display:none">
  <div id="login-box">
    <h2>{{TITLE}}</h2>
    <div class="login-field">
      <label>Username</label>
      <input id="login-username" type="text" autocomplete="username" placeholder="username">
    </div>
    <div class="login-field">
      <label>Password</label>
      <input id="login-password" type="password" autocomplete="current-password" placeholder="password">
    </div>
    <div id="login-error"></div>
    <button id="btn-login" onclick="doLogin()">Sign in</button>
  </div>
</div>
<div id="app">
  <div id="sidebar-backdrop" onclick="closeSidebarOnMobile()"></div>
  <!-- Sidebar -->
  <div id="sidebar">
    <div id="sidebar-header">
      <span id="sidebar-title">{{TITLE}}</span>
      <button id="btn-new" onclick="newChat()">+ New</button>
    </div>
    <div id="chat-list"></div>
  </div>

  <!-- Main -->
  <div id="main">
    <div id="main-header">
      <button id="btn-menu" title="Chats" aria-label="Toggle chat sidebar" aria-expanded="false" onclick="toggleSidebar()">
        <svg viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
      </button>
      <span id="chat-title-display"></span>
    </div>
    <div id="empty-state">
      <h2>{{TITLE}}</h2>
      <p>Start a conversation with the agent.</p>
      <button id="btn-new-big" onclick="newChat()">New Chat</button>
    </div>
    <div id="messages" style="display:none"></div>
    <div id="input-area" style="display:none">
      <div id="attach-preview"></div>
      <div id="input-wrap">
        <button id="btn-attach" title="Attach file" onclick="document.getElementById('file-input').click()">
          <svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5V6H9v9.5a3 3 0 0 0 6 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
        </button>
        <input id="file-input" type="file" multiple accept="image/*,*" style="display:none" onchange="onFilesSelected(event)">
        <textarea id="msg-input" rows="1" placeholder="Message…"></textarea>
        <button id="btn-send" onclick="sendMessage()" disabled>
          <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>
  </div>
</div>

<script>// ── Auth ─────────────────────────────────────────────────────────────────
const TOKEN_KEY = 'nanobot_token_v1';
let authToken = localStorage.getItem(TOKEN_KEY) || '';

async function initAuth() {
  // Ask server if auth is required
  const res = await fetch('/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: '__probe__', password: '__probe__' }),
  }).catch(() => null);

  if (!res) return; // server error, just proceed

  if (res.status === 401) {
    // Auth is configured; validate stored token via a WS probe or just show login if no token
    if (!authToken) { showLogin(); return; }
    // Verify token works by hitting upload with no file (will fail gracefully)
    const check = await fetch('/upload', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${authToken}` },
      body: new FormData(), // empty – server will reject file, but 401 vs 422 tells us if token is valid
    }).catch(() => null);
    if (check && check.status === 401) { authToken = ''; localStorage.removeItem(TOKEN_KEY); showLogin(); }
  }
  // If 200 (no auth required) – token stays empty, UI proceeds normally
}

function showLogin() {
  document.getElementById('login-overlay').style.display = 'flex';
  document.getElementById('login-username').focus();
}
function hideLogin() {
  document.getElementById('login-overlay').style.display = 'none';
}

async function doLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  errEl.textContent = '';
  const res = await fetch('/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password }),
  });
  if (res.ok) {
    const data = await res.json();
    authToken = data.token || '';
    if (authToken) localStorage.setItem(TOKEN_KEY, authToken);
    hideLogin();
  } else {
    errEl.textContent = 'Invalid username or password.';
  }
}

// Allow Enter key in login form
document.getElementById('login-password').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') doLogin();
});
document.getElementById('login-username').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') document.getElementById('login-password').focus();
});
// ── Storage helpers ──────────────────────────────────────────────────────
const STORE_KEY = 'nanobot_chats_v1';

function loadStore() {
  try { return JSON.parse(localStorage.getItem(STORE_KEY) || '{}'); } catch { return {}; }
}
function saveStore(s) { localStorage.setItem(STORE_KEY, JSON.stringify(s)); }

function getChats() {
  const s = loadStore();
  return { chats: s.chats || {}, order: s.order || [] };
}
function saveChats(chats, order) {
  saveStore({ chats, order });
}

function randomUUID() {
  // crypto.randomUUID() requires a secure context (HTTPS/localhost); fall back otherwise.
  if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
    const r = Math.random() * 16 | 0;
    return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
  });
}

function createChat() {
  const id = randomUUID();
  const now = new Date().toISOString();
  return { id, title: 'New Chat', messages: [], created: now };
}

function addMessage(chatId, role, content, media_paths) {
  const { chats, order } = getChats();
  if (!chats[chatId]) return;
  chats[chatId].messages.push({ role, content, media_paths: media_paths || [], timestamp: new Date().toISOString() });
  // Auto-title: first user message (trimmed to 60 chars)
  if (role === 'user' && chats[chatId].title === 'New Chat') {
    const titleText = content || (media_paths && media_paths.length ? media_paths[0].split('/').pop() : 'New Chat');
    chats[chatId].title = titleText.trim().slice(0, 60) + (titleText.length > 60 ? '\u2026' : '');
  }
  saveChats(chats, order);
}

// ── State ────────────────────────────────────────────────────────────────
let activeChatId = null;
let ws = null;
let waitingReply = false;

function isMobileView() {
  return window.matchMedia('(max-width:768px)').matches;
}
function closeSidebarOnMobile() {
  if (isMobileView()) {
    document.getElementById('app').classList.remove('sidebar-open');
    document.getElementById('btn-menu').setAttribute('aria-expanded', 'false');
  }
}
function toggleSidebar() {
  const app = document.getElementById('app');
  app.classList.toggle('sidebar-open');
  document.getElementById('btn-menu').setAttribute(
    'aria-expanded',
    app.classList.contains('sidebar-open') ? 'true' : 'false',
  );
}

// ── WebSocket ────────────────────────────────────────────────────────────
function connectWS(chatId) {
  if (ws) { try { ws.close(); } catch {} ws = null; }

  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  const tokenParam = authToken ? `?token=${encodeURIComponent(authToken)}` : '';
  ws = new WebSocket(`${proto}://${location.host}/ws/${chatId}${tokenParam}`);

  ws.onopen = () => {
    document.getElementById('btn-send').disabled = false;
  };

  ws.onmessage = (ev) => {
    try {
      const data = JSON.parse(ev.data);
      if (data.type === 'message' && data.chat_id === activeChatId) {
        removeTyping();
        addMessage(activeChatId, 'assistant', data.content, []);
        appendBubble('assistant', data.content, []);
        waitingReply = false;
        renderSidebar();
      }
    } catch (e) { console.error('WS parse error', e); }
  };

  ws.onclose = () => {
    document.getElementById('btn-send').disabled = true;
    // Reconnect after a short delay if still on the same chat
    if (activeChatId === chatId) {
      setTimeout(() => { if (activeChatId === chatId) connectWS(chatId); }, 2000);
    }
  };

  ws.onerror = () => ws.close();
}

// ── Attachments ─────────────────────────────────────────────────────────
let pendingAttachments = []; // [{name, path, objectUrl, isImage}]

async function onFilesSelected(ev) {
  const files = Array.from(ev.target.files);
  ev.target.value = '';
  for (const file of files) {
    const fd = new FormData();
    fd.append('file', file);
    try {
      const res = await fetch('/upload', { method: 'POST', headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}, body: fd });
      if (!res.ok) throw new Error(await res.text());
      const { path } = await res.json();
      const isImage = file.type.startsWith('image/');
      const objectUrl = isImage ? URL.createObjectURL(file) : null;
      pendingAttachments.push({ name: file.name, path, objectUrl, isImage });
      renderAttachPreview();
    } catch (e) {
      console.error('Upload failed', e);
    }
  }
}

function renderAttachPreview() {
  const bar = document.getElementById('attach-preview');
  bar.innerHTML = '';
  pendingAttachments.forEach((a, i) => {
    const chip = document.createElement('div');
    chip.className = 'attach-chip';
    if (a.isImage) {
      const img = document.createElement('img');
      img.src = a.objectUrl;
      chip.appendChild(img);
    }
    const name = document.createElement('span');
    name.className = 'attach-chip-name';
    name.textContent = a.name;
    const del = document.createElement('button');
    del.className = 'attach-chip-del';
    del.textContent = '×';
    del.onclick = () => {
      if (a.objectUrl) URL.revokeObjectURL(a.objectUrl);
      pendingAttachments.splice(i, 1);
      renderAttachPreview();
    };
    chip.appendChild(name);
    chip.appendChild(del);
    bar.appendChild(chip);
  });
}

// ── Send ─────────────────────────────────────────────────────────────────
function sendMessage() {
  const input = document.getElementById('msg-input');
  const content = input.value.trim();
  if ((!content && pendingAttachments.length === 0) || !activeChatId || waitingReply) return;
  if (!ws || ws.readyState !== WebSocket.OPEN) return;

  input.value = '';
  input.style.height = 'auto';

  const media_paths = pendingAttachments.map(a => a.path);
  const previewAttachments = [...pendingAttachments];
  pendingAttachments = [];
  renderAttachPreview();

  addMessage(activeChatId, 'user', content, media_paths);
  appendBubble('user', content, previewAttachments);
  renderSidebar();

  ws.send(JSON.stringify({ type: 'message', content, chat_id: activeChatId, media_paths }));
  waitingReply = true;
  showTyping();
}

// ── Rendering ────────────────────────────────────────────────────────────
const md = (text) => {
  try { return marked.parse(text, { breaks: true, gfm: true }); } catch { return text; }
};

function appendBubble(role, content, attachments) {
  const el = document.getElementById('messages');
  const now = new Date();
  const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  const msg = document.createElement('div');
  msg.className = `msg ${role}`;

  const bubble = document.createElement('div');
  bubble.className = 'bubble';

  // Render attachments (images as thumbnails, others as file chips)
  const items = attachments || [];
  for (const a of items) {
    if (a.isImage && a.objectUrl) {
      const img = document.createElement('img');
      img.src = a.objectUrl;
      img.className = 'bubble-img';
      img.onclick = () => window.open(a.objectUrl, '_blank');
      bubble.appendChild(img);
    } else {
      const chip = document.createElement('div');
      chip.className = 'bubble-file';
      chip.innerHTML = `<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1.5V8H18.5L13 3.5zM6 20V4h5v5h5v11H6z"/></svg>`;
      chip.appendChild(document.createTextNode(a.name || a.path?.split('/').pop() || 'file'));
      bubble.appendChild(chip);
    }
  }

  if (role === 'assistant') {
    bubble.innerHTML += md(content);
  } else if (content) {
    const p = document.createElement('p');
    p.textContent = content;
    bubble.appendChild(p);
  }

  const time = document.createElement('span');
  time.className = 'msg-time';
  time.textContent = timeStr;

  msg.appendChild(bubble);
  msg.appendChild(time);
  el.appendChild(msg);
  el.scrollTop = el.scrollHeight;
}

function showTyping() {
  const el = document.getElementById('messages');
  const typing = document.createElement('div');
  typing.className = 'msg assistant';
  typing.id = 'typing-indicator';
  const bubble = document.createElement('div');
  bubble.className = 'bubble typing-bubble';
  bubble.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
  typing.appendChild(bubble);
  el.appendChild(typing);
  el.scrollTop = el.scrollHeight;
}

function removeTyping() {
  const t = document.getElementById('typing-indicator');
  if (t) t.remove();
}

function renderMessages(chatId) {
  const el = document.getElementById('messages');
  el.innerHTML = '';
  const { chats } = getChats();
  const chat = chats[chatId];
  if (!chat) return;
  for (const m of chat.messages) {
    // Reconstruct attachment-like objects for stored messages (no objectUrl available)
    const attachments = (m.media_paths || []).map(p => ({
      name: p.split('/').pop(),
      path: p,
      objectUrl: null,
      isImage: /\.(jpg|jpeg|png|gif|webp)$/i.test(p),
    }));
    appendBubble(m.role, m.content, attachments);
  }
}

function renderSidebar() {
  const { chats, order } = getChats();
  const list = document.getElementById('chat-list');
  list.innerHTML = '';
  for (const id of [...order].reverse()) {
    const chat = chats[id];
    if (!chat) continue;
    const item = document.createElement('div');
    item.className = 'chat-item' + (id === activeChatId ? ' active' : '');
    item.onclick = () => openChat(id);

    const title = document.createElement('span');
    title.className = 'chat-item-title';
    title.textContent = chat.title;

    const del = document.createElement('button');
    del.className = 'chat-item-del';
    del.title = 'Delete chat';
    del.textContent = '×';
    del.onclick = (e) => { e.stopPropagation(); deleteChat(id); };

    item.appendChild(title);
    item.appendChild(del);
    list.appendChild(item);
  }
}

// ── Chat actions ─────────────────────────────────────────────────────────
function newChat() {
  const chat = createChat();
  const { chats, order } = getChats();
  chats[chat.id] = chat;
  order.push(chat.id);
  saveChats(chats, order);
  openChat(chat.id);
}

function openChat(id) {
  activeChatId = id;
  waitingReply = false;
  removeTyping();

  const { chats } = getChats();
  const chat = chats[id];
  if (!chat) return;

  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('messages').style.display = 'flex';
  document.getElementById('input-area').style.display = 'block';
  document.getElementById('chat-title-display').textContent = chat.title;

  renderMessages(id);
  renderSidebar();
  connectWS(id);
  closeSidebarOnMobile();

  document.getElementById('msg-input').focus();
}

function deleteChat(id) {
  const { chats, order } = getChats();
  delete chats[id];
  const idx = order.indexOf(id);
  if (idx !== -1) order.splice(idx, 1);
  saveChats(chats, order);

  if (activeChatId === id) {
    activeChatId = null;
    if (ws) { try { ws.close(); } catch {} ws = null; }
    document.getElementById('empty-state').style.display = 'flex';
    document.getElementById('messages').style.display = 'none';
    document.getElementById('input-area').style.display = 'none';
    document.getElementById('chat-title-display').textContent = '';
    document.getElementById('btn-send').disabled = true;
  }
  renderSidebar();
}

// ── Input auto-resize & keyboard shortcut ────────────────────────────────
const input = document.getElementById('msg-input');
input.addEventListener('input', () => {
  input.style.height = 'auto';
  input.style.height = Math.min(input.scrollHeight, 200) + 'px';
});
input.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// ── Init ─────────────────────────────────────────────────────────────────
renderSidebar();
// Check auth then re-open the most recent chat on page load
initAuth().then(() => {
  const { order } = getChats();
  if (order.length > 0) {
    openChat(order[order.length - 1]);
  }
});
</script>
</body>
</html>
